<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>OpenAI Chat</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#f4f7fb;display:flex;flex-direction:column;height:100vh;}
header{background:#4a6cf7;color:#fff;padding:15px;text-align:center;font-size:20px;}
.chat-container{flex:1;overflow-y:auto;padding:20px;}
.bubble{max-width:70%;padding:12px;border-radius:14px;margin-bottom:12px;position:relative;}
.bubble.user{margin-left:auto;background:#4a6cf7;color:#fff;}
.bubble.ai{margin-right:auto;background:#fff;border:1px solid #ccc;}
.copy-btn{position:absolute;right:8px;top:4px;font-size:10px;display:none;}
.bubble:hover .copy-btn{display:block;}
.token-counter{padding:10px;background:#e2e6ef;text-align:right;font-size:13px;}
.input-area{display:flex;background:white;padding:10px;}
.input-area input{flex:1;padding:12px;border-radius:10px;border:1px solid #ccc;}
.input-area button{margin-left:8px;padding:12px;border:none;background:#4a6cf7;color:white;border-radius:10px;}
</style>
</head>
<body>

<header>OpenAI Chat</header>
<div class="chat-container" id="chat"></div>

<div class="token-counter" id="tokens">
서버 계산 토큰: 0 | 클라이언트 추정 토큰: 0
</div>

<div class="input-area">
  <input id="msg" placeholder="메시지 입력..." onkeydown="if(event.key==='Enter') send();">
  <button onclick="send()">보내기</button>
  <button onclick="useLast()">마지막답변</button>
</div>

<script>
const chat = document.getElementById("chat");
const tokens = document.getElementById("tokens");
const sessionId = "session1";

let lastQuestion="", lastAiAnswer="";
let totalServer=0, totalClient=0;

const ws = new WebSocket("ws://localhost:8080/ws/chat");
ws.onmessage = e => {
    const d=JSON.parse(e.data);
    showAi(d.reply,d.usage.total_tokens);
};

function tokenCalc(str){ return Math.ceil(str.length/4); }

function updateTokens(){
    tokens.textContent = "서버 계산 토큰: "+totalServer+
                         " | 클라이언트 추정 토큰: "+totalClient;
}

function showUser(t){
    showBubble(t,"user");
    totalClient+=tokenCalc(t);
    updateTokens();
}

function showAi(t,serverTokens){
    lastAiAnswer=t;
    showBubble(t,"ai",true);

    totalServer+=serverTokens;
    totalClient+=tokenCalc(t);

    updateTokens();
}

function showBubble(text,role,md=false){
    const b=document.createElement("div"); b.className="bubble "+role;
    const copy=document.createElement("button"); copy.textContent="복사"; copy.className="copy-btn";
    copy.onclick=()=>navigator.clipboard.writeText(text); b.appendChild(copy);

    const c=document.createElement("div");
    c.innerHTML = md ? marked.parse(text) : text;
    b.appendChild(c);

    chat.appendChild(b);
    chat.scrollTop=chat.scrollHeight;
}

function send(){
    const msg=document.getElementById("msg").value.trim();
    if(!msg) return;
    document.getElementById("msg").value="";
    
    lastQuestion=msg;
    showUser(msg);

    fetch("/api/chat/"+sessionId,{method:"POST",headers:{"Content-Type":"text/plain"},body:msg})
       .then(r=>r.json())
       .then(d=>showAi(d.reply,d.usage.total_tokens));

    ws.send(msg);
}

function useLast(){
    if(!lastAiAnswer || !lastQuestion){ alert("기록 없음"); return; }
    showUser("(마지막답변 사용)");

    fetch("/api/chat/lastAnswer",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({sessionId,lastQuestion,lastAiAnswer})})
    .then(r=>r.json())
    .then(d=>showAi(d.reply,d.usage.total_tokens));
}
</script>

</body>
</html>